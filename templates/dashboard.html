{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="{{ current_user.role }}-dashboard">
        <!-- Dashboard Header -->
        <div class="dashboard-header animate-fade-in">
            <div class="row align-items-center">
                <div class="col">
                    <div class="welcome-text">
                        <h1>Welcome, {{ current_user.name }}</h1>
                        <p>{{ current_user.role|title }} Dashboard</p>
                    </div>
                </div>
                {% if current_user.role == 'student' %}
                <div class="col-auto">
                    <a href="{{ url_for('new_application') }}" class="btn btn-light">
                        <i class="fas fa-plus-circle me-2"></i>New Application
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stats-card animate-fade-in">
                    <div class="stats-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="stats-number">{{ applications|length }}</h3>
                        <p class="stats-label">{% if current_user.role == 'student' %}Total Applications{% else %}Pending Review{% endif %}</p>
                    </div>
                </div>
            </div>
            {% if current_user.role == 'student' %}
            <div class="col-md-4">
                <div class="stats-card success animate-fade-in">
                    <div class="stats-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="stats-number">{{ applications|selectattr('principal_status', 'equalto', 'approved')|list|length }}</h3>
                        <p class="stats-label">Approved</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card warning animate-fade-in">
                    <div class="stats-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="stats-number">{{ applications|selectattr('principal_status', 'equalto', 'pending')|list|length }}</h3>
                        <p class="stats-label">Pending</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Applications List -->
        {% if applications %}
        <div class="row g-4">
            {% for application in applications %}
            <div class="col-md-6">
                <div class="application-card animate-fade-in">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ application.project_title }}</h5>
                            <span class="status-badge {{ application.principal_status }}">
                                <i class="fas {% if application.principal_status == 'approved' %}fa-check-circle{% elif application.principal_status == 'rejected' %}fa-times-circle{% else %}fa-clock{% endif %} me-2"></i>
                                {{ application.principal_status|title }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-sm-6">
                                <div class="detail-item">
                                    <i class="fas fa-hashtag text-primary me-2"></i>
                                    <span>{{ application.application_number }}</span>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="detail-item">
                                    <i class="fas fa-rupee-sign text-success me-2"></i>
                                    <span>{{ "%.2f"|format(application.total_cost) }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Steps -->
                        <div class="progress-steps mb-4">
                            <div class="step {% if application.dept_status == 'approved' %}completed{% elif application.dept_status == 'pending' %}active{% endif %}">
                                {% if application.dept_status == 'approved' %}
                                <i class="fas fa-check"></i>
                                {% else %}1{% endif %}
                            </div>
                            <div class="step {% if application.college_status == 'approved' %}completed{% elif application.college_status == 'pending' and application.dept_status == 'approved' %}active{% endif %}">
                                {% if application.college_status == 'approved' %}
                                <i class="fas fa-check"></i>
                                {% else %}2{% endif %}
                            </div>
                            <div class="step {% if application.principal_status == 'approved' %}completed{% elif application.principal_status == 'pending' and application.college_status == 'approved' %}active{% endif %}">
                                {% if application.principal_status == 'approved' %}
                                <i class="fas fa-check"></i>
                                {% else %}3{% endif %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('view_application', id=application.id) }}" class="btn btn-primary">
                                <i class="fas fa-eye me-2"></i>View Details
                            </a>
                            
                            {% if current_user.role == 'dept_coord' and application.dept_status == 'pending' %}
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ application.id }}">
                                <i class="fas fa-check me-2"></i>Approve
                            </button>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ application.id }}">
                                <i class="fas fa-times me-2"></i>Reject
                            </button>
                            {% endif %}
                            
                            {% if current_user.role == 'college_coord' and application.dept_status == 'approved' and application.college_status == 'pending' %}
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ application.id }}">
                                <i class="fas fa-check me-2"></i>Approve
                            </button>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ application.id }}">
                                <i class="fas fa-times me-2"></i>Reject
                            </button>
                            {% endif %}
                            
                            {% if current_user.role == 'principal' and application.college_status == 'approved' and application.principal_status == 'pending' %}
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ application.id }}">
                                <i class="fas fa-check me-2"></i>Approve
                            </button>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ application.id }}">
                                <i class="fas fa-times me-2"></i>Reject
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approve Modal -->
            <div class="modal fade" id="approveModal{{ application.id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Approve Application</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <h6 class="alert-heading mb-2">Application Details</h6>
                                <p class="mb-1"><strong>Project:</strong> {{ application.project_title }}</p>
                                <p class="mb-0"><strong>Total Cost:</strong> ₹{{ "%.2f"|format(application.total_cost) }}</p>
                            </div>
                            <p class="text-muted">Are you sure you want to approve this application?</p>
                        </div>
                        <div class="modal-footer">
                            <form action="{% if current_user.role == 'dept_coord' %}{{ url_for('approve_dept', id=application.id) }}{% elif current_user.role == 'college_coord' %}{{ url_for('approve_college', id=application.id) }}{% elif current_user.role == 'principal' %}{{ url_for('approve_principal', id=application.id) }}{% endif %}" method="POST">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check me-2"></i>Confirm Approval
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reject Modal -->
            <div class="modal fade" id="rejectModal{{ application.id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Reject Application</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form action="{% if current_user.role == 'dept_coord' %}{{ url_for('reject_dept', id=application.id) }}{% elif current_user.role == 'college_coord' %}{{ url_for('reject_college', id=application.id) }}{% elif current_user.role == 'principal' %}{{ url_for('reject_principal', id=application.id) }}{% endif %}" method="POST">
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <h6 class="alert-heading mb-2">Application Details</h6>
                                    <p class="mb-1"><strong>Project:</strong> {{ application.project_title }}</p>
                                    <p class="mb-0"><strong>Total Cost:</strong> ₹{{ "%.2f"|format(application.total_cost) }}</p>
                                </div>
                                <div class="mb-3">
                                    <label for="reason" class="form-label">Reason for Rejection</label>
                                    <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-times me-2"></i>Confirm Rejection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle fa-2x me-3"></i>
                <div>
                    {% if current_user.role == 'student' %}
                    <h5 class="alert-heading mb-1">No Applications Found</h5>
                    <p class="mb-0">Click "New Application" to submit your first SSIP application.</p>
                    {% else %}
                    <h5 class="alert-heading mb-1">No Pending Applications</h5>
                    <p class="mb-0">There are no applications requiring your review at this time.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
