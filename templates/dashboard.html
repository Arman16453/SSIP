{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="{{ current_user.role }}-dashboard">
        <!-- Dashboard Header -->
        <div class="dashboard-header animate-fade-in mb-4">
            <div class="row align-items-center">
                <div class="col">
                    <div class="welcome-text">
                        <h1>Welcome, {{ current_user.name }}</h1>
                        <p>{{ current_user.role|title }} Dashboard</p>
                    </div>
                </div>
                {% if current_user.role == 'student' %}
                <div class="col-auto">
                    <a href="{{ url_for('new_application') }}" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i>New Application
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stats-card animate-fade-in">
                    <div class="stats-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="stats-number">{{ applications|length }}</h3>
                        <p class="stats-label">{% if current_user.role == 'student' %}Total Applications{% else %}Pending Review{% endif %}</p>
                    </div>
                </div>
            </div>
            {% if current_user.role == 'student' %}
            <div class="col-md-4">
                <div class="stats-card success animate-fade-in">
                    <div class="stats-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="stats-number">{{ applications|selectattr('principal_status', 'equalto', 'approved')|list|length }}</h3>
                        <p class="stats-label">Approved</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card warning animate-fade-in">
                    <div class="stats-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="stats-number">{{ applications|selectattr('principal_status', 'equalto', 'pending')|list|length }}</h3>
                        <p class="stats-label">Pending</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Current Applications -->
        <div class="current-applications mb-5">
            <h3 class="mb-4">Current Applications</h3>
            {% if applications %}
            <div class="row g-4">
                {% for application in applications %}
                <div class="col-md-6">
                    <div class="card application-card animate-fade-in">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">{{ application.project_title }}</h5>
                                <span class="badge {% if application.principal_status == 'approved' %}bg-success{% elif application.principal_status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                                    {{ application.principal_status|title }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p><strong>Application Number:</strong> {{ application.application_number }}</p>
                            <p><strong>Total Cost:</strong> â‚¹{{ "%.2f"|format(application.total_cost) }}</p>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-3">
                                <a href="{{ url_for('view_application', id=application.id) }}" class="btn btn-primary">
                                    <i class="fas fa-eye me-2"></i>View Details
                                </a>
                                
                                {% if current_user.role == 'dept_coord' and application.dept_status == 'pending' %}
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ application.id }}">
                                    <i class="fas fa-check me-2"></i>Approve
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ application.id }}">
                                    <i class="fas fa-times me-2"></i>Reject
                                </button>
                                {% endif %}
                                
                                {% if current_user.role == 'college_coord' and application.dept_status == 'approved' and application.college_status == 'pending' %}
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ application.id }}">
                                    <i class="fas fa-check me-2"></i>Approve
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ application.id }}">
                                    <i class="fas fa-times me-2"></i>Reject
                                </button>
                                {% endif %}
                                
                                {% if current_user.role == 'principal' and application.college_status == 'approved' and application.principal_status == 'pending' %}
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ application.id }}">
                                    <i class="fas fa-check me-2"></i>Approve
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ application.id }}">
                                    <i class="fas fa-times me-2"></i>Reject
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Approve Modal -->
                    <div class="modal fade" id="approveModal{{ application.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Approve Application</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form action="{% if current_user.role == 'dept_coord' %}{{ url_for('approve_dept', id=application.id) }}{% elif current_user.role == 'college_coord' %}{{ url_for('approve_college', id=application.id) }}{% else %}{{ url_for('approve_principal', id=application.id) }}{% endif %}" method="POST">
                                    <div class="modal-body">
                                        <p>Are you sure you want to approve this application?</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-success">Approve</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Reject Modal -->
                    <div class="modal fade" id="rejectModal{{ application.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Reject Application</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form action="{% if current_user.role == 'dept_coord' %}{{ url_for('reject_dept', id=application.id) }}{% elif current_user.role == 'college_coord' %}{{ url_for('reject_college', id=application.id) }}{% else %}{{ url_for('reject_principal', id=application.id) }}{% endif %}" method="POST">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="reason" class="form-label">Reason for Rejection</label>
                                            <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-danger">Reject</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3"></i>
                    <div>
                        {% if current_user.role == 'student' %}
                        <h5 class="alert-heading mb-1">No Applications Found</h5>
                        <p class="mb-0">Click "New Application" to submit your first SSIP application.</p>
                        {% else %}
                        <h5 class="alert-heading mb-1">No Pending Applications</h5>
                        <p class="mb-0">There are no applications requiring your review at this time.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Applications History -->
        <div class="applications-history mt-5">
            <h3 class="mb-4">Applications History</h3>
            {% if approved_applications or rejected_applications %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Application Number</th>
                            <th>Project Title</th>
                            <th>Submission Date</th>
                            <th>Status</th>
                            <th>Review Date</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in approved_applications %}
                        <tr class="table-success">
                            <td>{{ app.application_number }}</td>
                            <td>{{ app.project_title }}</td>
                            <td>{{ app.created_at.strftime('%Y-%m-%d') }}</td>
                            <td><span class="badge bg-success">Approved</span></td>
                            <td>
                                {% if current_user.role == 'dept_coord' %}
                                    {{ app.dept_review_date.strftime('%Y-%m-%d') if app.dept_review_date }}
                                {% elif current_user.role == 'college_coord' %}
                                    {{ app.college_review_date.strftime('%Y-%m-%d') if app.college_review_date }}
                                {% else %}
                                    {{ app.principal_review_date.strftime('%Y-%m-%d') if app.principal_review_date }}
                                {% endif %}
                            </td>
                            <td>
                                {% if current_user.role == 'dept_coord' %}
                                    {{ app.dept_remarks }}
                                {% elif current_user.role == 'college_coord' %}
                                    {{ app.college_remarks }}
                                {% else %}
                                    {{ app.principal_remarks }}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('view_application', id=app.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for app in rejected_applications %}
                        <tr class="table-danger">
                            <td>{{ app.application_number }}</td>
                            <td>{{ app.project_title }}</td>
                            <td>{{ app.created_at.strftime('%Y-%m-%d') }}</td>
                            <td><span class="badge bg-danger">Rejected</span></td>
                            <td>
                                {% if current_user.role == 'dept_coord' %}
                                    {{ app.dept_review_date.strftime('%Y-%m-%d') if app.dept_review_date }}
                                {% elif current_user.role == 'college_coord' %}
                                    {{ app.college_review_date.strftime('%Y-%m-%d') if app.college_review_date }}
                                {% else %}
                                    {{ app.principal_review_date.strftime('%Y-%m-%d') if app.principal_review_date }}
                                {% endif %}
                            </td>
                            <td>
                                {% if current_user.role == 'dept_coord' %}
                                    {{ app.dept_remarks }}
                                {% elif current_user.role == 'college_coord' %}
                                    {{ app.college_remarks }}
                                {% else %}
                                    {{ app.principal_remarks }}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('view_application', id=app.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <p class="mb-0">No application history found.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
